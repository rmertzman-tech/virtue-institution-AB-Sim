<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtue Ethics Simulator | Ethics Beyond Boundaries</title>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.95;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .welcome-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .welcome-section h2 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .controls {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .control-group select,
        .control-group input[type="range"] {
            width: 100%;
            padding: 12px;
            font-size: 1em;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .slider-value {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 15px 25px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .radio-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .radio-option.selected {
            border-color: #667eea;
            background: #e8f0fe;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            flex: 1;
            padding: 18px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .results-section {
            display: none;
            margin-top: 30px;
        }
        
        .results-section.active {
            display: block;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .metric-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .metric-change {
            font-size: 1em;
            margin-top: 8px;
        }
        
        .metric-change.positive {
            color: #4CAF50;
        }
        
        .metric-change.negative {
            color: #f44336;
        }
        
        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e0e0e0;
        }
        
        .chart-container h3 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        .comparison-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            border: 3px solid;
        }
        
        .comparison-card.metabolic {
            border-color: #4CAF50;
        }
        
        .comparison-card.extractive {
            border-color: #f44336;
        }
        
        .comparison-card h3 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .comparison-card.metabolic h3 {
            color: #4CAF50;
        }
        
        .comparison-card.extractive h3 {
            color: #f44336;
        }
        
        .insight-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-left: 5px solid #667eea;
            padding: 25px;
            border-radius: 10px;
            margin: 30px 0;
        }
        
        .insight-box h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .insight-box p {
            line-height: 1.7;
            font-size: 1.1em;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        
        .progress-bar.active {
            display: block;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .status-message {
            text-align: center;
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            display: none;
        }
        
        .status-message.active {
            display: block;
        }
        
        .status-message.info {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status-message.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .scenario-info {
            background: #fff3e0;
            border-left: 4px solid #FF9800;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .scenario-info h4 {
            color: #e65100;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .radio-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è Virtue Ethics Simulator</h1>
            <p>Explore How Institutional Design Affects Human Flourishing</p>
            <p style="font-size: 0.9em; margin-top: 10px;">Ethics Beyond Boundaries | St. Petersburg College</p>
        </div>
        
        <div class="main-content">
            <!-- Welcome Section -->
            <div class="welcome-section" id="welcomeSection">
                <h2>üëã Welcome to the Interactive Simulation</h2>
                <p style="line-height: 1.7; margin-bottom: 15px;">
                    This tool lets you explore how ethical crises spread through communities and how different 
                    institutional designs enable or destroy human flourishing. Based on agent-based modeling 
                    research and Aristotelian virtue ethics.
                </p>
                <p style="line-height: 1.7;">
                    <strong>Quick Start:</strong> Choose a scenario below, select your mode, and click "Run Simulation" 
                    to see how virtues, stress, and flourishing evolve over time in different institutional contexts.
                </p>
            </div>
            
            <!-- Controls -->
            <div class="controls">
                <h2 style="color: #667eea; margin-bottom: 25px;">‚öôÔ∏è Simulation Controls</h2>
                
                <!-- Scenario Selection -->
                <div class="control-group">
                    <label for="scenarioSelect">Choose Ethical Scenario:</label>
                    <select id="scenarioSelect">
                        <option value="healthcare">Healthcare Moral Injury (COVID burnout)</option>
                        <option value="whistleblower">Whistleblower Retaliation (Challenger disaster)</option>
                        <option value="corruption">Corruption Cascade (Enron scandal)</option>
                        <option value="harassment">Workplace Harassment Cover-Up (#MeToo)</option>
                        <option value="academic">Academic Dishonesty Ring</option>
                        <option value="environmental">Environmental Destruction Hidden</option>
                    </select>
                </div>
                
                <!-- Scenario Description -->
                <div class="scenario-info" id="scenarioInfo">
                    <h4>üìñ About This Scenario</h4>
                    <p id="scenarioDescription"></p>
                    <p style="margin-top: 10px;"><strong>Tests virtue:</strong> <span id="scenarioVirtue"></span></p>
                    <p><strong>Connects to:</strong> <span id="scenarioConnection"></span></p>
                </div>
                
                <!-- Mode Selection -->
                <div class="control-group">
                    <label>Simulation Mode:</label>
                    <div class="radio-group">
                        <label class="radio-option selected" id="modeIndividual">
                            <input type="radio" name="mode" value="individual" checked>
                            <span>üë§ Single Institution</span>
                        </label>
                        <label class="radio-option" id="modeComparison">
                            <input type="radio" name="mode" value="comparison">
                            <span>‚öñÔ∏è Compare Both (Recommended!)</span>
                        </label>
                    </div>
                </div>
                
                <!-- Institution Type (only for individual mode) -->
                <div class="control-group" id="institutionTypeGroup">
                    <label>Institution Type:</label>
                    <div class="radio-group">
                        <label class="radio-option selected" id="instMetabolic">
                            <input type="radio" name="institution" value="metabolic" checked>
                            <span>üå± Metabolic (Supportive)</span>
                        </label>
                        <label class="radio-option" id="instExtractive">
                            <input type="radio" name="institution" value="extractive">
                            <span>‚ö° Extractive (Punitive)</span>
                        </label>
                    </div>
                </div>
                
                <!-- Parameters -->
                <div class="control-group">
                    <label for="numAgents">
                        Number of Agents: <span class="slider-value" id="numAgentsValue">100</span>
                    </label>
                    <input type="range" id="numAgents" min="50" max="200" value="100" step="10">
                </div>
                
                <div class="control-group">
                    <label for="numTimesteps">
                        Simulation Length: <span class="slider-value" id="numTimestepsValue">50</span> timesteps
                    </label>
                    <input type="range" id="numTimesteps" min="30" max="100" value="50" step="5">
                </div>
                
                <!-- Run Buttons -->
                <div class="button-group">
                    <button class="btn btn-primary" id="runButton">üöÄ Run Simulation</button>
                    <button class="btn btn-secondary" id="downloadButton" disabled>üì• Download Data</button>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            
            <!-- Status Message -->
            <div class="status-message" id="statusMessage"></div>
            
            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <!-- Metrics Overview -->
                <h2 style="color: #667eea; margin-bottom: 20px;">üìä Results</h2>
                
                <div class="metrics-grid" id="metricsGrid">
                    <!-- Metrics will be inserted here -->
                </div>
                
                <!-- Insight Box -->
                <div class="insight-box" id="insightBox" style="display: none;">
                    <!-- Insight will be inserted here -->
                </div>
                
                <!-- Charts -->
                <div class="chart-container">
                    <h3>Eudaimonia (Flourishing) Over Time</h3>
                    <canvas id="eudaimoniaChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Virtue Dynamics Over Time</h3>
                    <canvas id="virtueChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Stress and Coherence</h3>
                    <canvas id="stressChart"></canvas>
                </div>
                
                <!-- Comparison Results (only shown in comparison mode) -->
                <div class="comparison-grid" id="comparisonGrid" style="display: none;">
                    <!-- Comparison cards will be inserted here -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ========================================================================
        // ETHICAL SCENARIOS DATABASE
        // ========================================================================
        
        const SCENARIOS = {
            healthcare: {
                name: "Healthcare Moral Injury",
                description: "Doctors and nurses forced to ration care, violating professional values. Burnout spreads through the system as caregivers face impossible choices.",
                virtue: "Temperance (Self-care)",
                connection: "COVID healthcare workers, Mara ICU nurse case study",
                shockSize: 0.20,
                shockType: "burnout"
            },
            whistleblower: {
                name: "Whistleblower Retaliation",
                description: "One employee reports safety violations and faces retaliation. Fear spreads through the organization as others witness the consequences.",
                virtue: "Courage",
                connection: "Roger Boisjoly & Challenger disaster",
                shockSize: 0.10,
                shockType: "cowardice"
            },
            corruption: {
                name: "Corruption Cascade",
                description: "Bribery scandal spreads through organization. Justice and trust collapse as ethical standards erode.",
                virtue: "Justice",
                connection: "Enron, institutional betrayal",
                shockSize: 0.15,
                shockType: "injustice"
            },
            harassment: {
                name: "Workplace Harassment Cover-Up",
                description: "Sexual harassment complaints ignored by HR. Fear and injustice spread as the institution protects perpetrators.",
                virtue: "Courage & Justice",
                connection: "#MeToo movement, institutional complicity",
                shockSize: 0.18,
                shockType: "injustice"
            },
            academic: {
                name: "Academic Dishonesty Ring",
                description: "Cheating ring discovered. Trust in academic integrity collapses as students question whether honesty is rewarded.",
                virtue: "Wisdom",
                connection: "Honor code violations, pressure culture",
                shockSize: 0.12,
                shockType: "foolishness"
            },
            environmental: {
                name: "Environmental Destruction Hidden",
                description: "Company hides environmental damage. Workers face moral conflict between livelihood and conscience.",
                virtue: "Justice",
                connection: "BP oil spill, corporate responsibility",
                shockSize: 0.14,
                shockType: "injustice"
            }
        };
        
        // ========================================================================
        // AGENT-BASED MODEL IMPLEMENTATION
        // ========================================================================
        
        class Agent {
            constructor(id) {
                this.id = id;
                this.virtues = {
                    courage: 50,
                    temperance: 50,
                    wisdom: 50,
                    justice: 50
                };
                this.eudaimonia = 50;
                this.stress = 0;
                this.prfCoherence = 1.0;
                this.moralDebt = 0;
                this.history = [];
            }
            
            calculateEudaimonia() {
                // Eudaimonia based on golden mean (50 is ideal)
                const deviations = Object.values(this.virtues)
                    .reduce((sum, v) => sum + Math.abs(v - 50), 0);
                const baseEud = Math.max(0, 100 - (deviations / 2));
                this.eudaimonia = Math.max(0, Math.min(100, 
                    baseEud * this.prfCoherence - (this.stress * 50)
                ));
                return this.eudaimonia;
            }
            
            recordHistory() {
                this.history.push({
                    virtues: {...this.virtues},
                    eudaimonia: this.eudaimonia,
                    stress: this.stress,
                    prfCoherence: this.prfCoherence,
                    moralDebt: this.moralDebt
                });
            }
        }
        
        class Community {
            constructor(numAgents, institutionType) {
                this.numAgents = numAgents;
                this.institutionType = institutionType;
                this.agents = [];
                this.repairEvents = { biobond: 0, civic: 0, institutional: 0 };
                
                // Create agents
                for (let i = 0; i < numAgents; i++) {
                    this.agents.push(new Agent(i));
                }
                
                // Create simple network (each agent connected to 3-5 others)
                this.connections = this.createNetwork();
            }
            
            createNetwork() {
                const connections = [];
                for (let i = 0; i < this.numAgents; i++) {
                    const numConnections = 3 + Math.floor(Math.random() * 3);
                    for (let j = 0; j < numConnections; j++) {
                        const target = Math.floor(Math.random() * this.numAgents);
                        if (target !== i) {
                            connections.push([i, target]);
                        }
                    }
                }
                return connections;
            }
            
            applyShock(scenario) {
                const numShocked = Math.floor(this.numAgents * scenario.shockSize);
                const shockedIndices = [];
                
                while (shockedIndices.length < numShocked) {
                    const idx = Math.floor(Math.random() * this.numAgents);
                    if (!shockedIndices.includes(idx)) {
                        shockedIndices.push(idx);
                    }
                }
                
                shockedIndices.forEach(idx => {
                    const agent = this.agents[idx];
                    agent.stress = 0.8;
                    agent.prfCoherence = 0.4;
                    
                    // Damage virtues based on shock type
                    if (scenario.shockType === 'cowardice') {
                        agent.virtues.courage -= 30;
                        agent.virtues.justice -= 15;
                    } else if (scenario.shockType === 'injustice') {
                        agent.virtues.justice -= 30;
                        agent.virtues.courage -= 15;
                    } else if (scenario.shockType === 'burnout') {
                        Object.keys(agent.virtues).forEach(v => {
                            agent.virtues[v] -= 20;
                        });
                    } else if (scenario.shockType === 'foolishness') {
                        agent.virtues.wisdom -= 30;
                        agent.virtues.temperance -= 15;
                    }
                    
                    agent.calculateEudaimonia();
                });
            }
            
            simulate(numTimesteps, progressCallback) {
                for (let t = 0; t < numTimesteps; t++) {
                    // Update progress
                    if (progressCallback) {
                        progressCallback((t / numTimesteps) * 100);
                    }
                    
                    // Update each agent
                    this.agents.forEach(agent => {
                        // Stress propagation
                        const neighbors = this.connections
                            .filter(([from, to]) => from === agent.id)
                            .map(([from, to]) => this.agents[to]);
                        
                        if (neighbors.length > 0) {
                            const avgNeighborStress = neighbors.reduce((sum, n) => sum + n.stress, 0) / neighbors.length;
                            agent.stress = Math.min(1.0, agent.stress + (avgNeighborStress * 0.4 / neighbors.length));
                        }
                        
                        // Stress damages virtues and coherence
                        if (agent.stress > 0.3) {
                            Object.keys(agent.virtues).forEach(v => {
                                agent.virtues[v] = Math.max(0, agent.virtues[v] - (0.03 * agent.stress));
                            });
                        }
                        
                        if (agent.stress > 0.5) {
                            agent.prfCoherence = Math.max(0, agent.prfCoherence - 0.02);
                        }
                        
                        // Moral debt accumulation
                        if (agent.stress > 0.4 && agent.eudaimonia < 40) {
                            agent.moralDebt = Math.min(100, agent.moralDebt + 0.1);
                        }
                        
                        agent.calculateEudaimonia();
                    });
                    
                    // Repair loops
                    this.applyRepairLoops();
                    
                    // Record history
                    this.agents.forEach(agent => agent.recordHistory());
                }
                
                if (progressCallback) {
                    progressCallback(100);
                }
            }
            
            applyRepairLoops() {
                const avgEudaimonia = this.agents.reduce((sum, a) => sum + a.eudaimonia, 0) / this.numAgents;
                
                this.agents.forEach(agent => {
                    // BioBond Loop - Personal resilience
                    if (agent.eudaimonia < 50 && Math.random() < 0.15) {
                        agent.stress = Math.max(0, agent.stress * 0.85);
                        agent.prfCoherence = Math.min(1.0, agent.prfCoherence + 0.05);
                        this.repairEvents.biobond++;
                    }
                    
                    // Civic Loop - Peer support (metabolic only)
                    if (this.institutionType === 'metabolic') {
                        if (agent.eudaimonia < 40 && Math.random() < 0.10) {
                            agent.moralDebt = Math.max(0, agent.moralDebt - 5);
                            agent.stress = Math.max(0, agent.stress * 0.90);
                            Object.keys(agent.virtues).forEach(v => {
                                agent.virtues[v] = Math.min(100, agent.virtues[v] + 2);
                            });
                            this.repairEvents.civic++;
                        }
                    }
                    
                    // Institutional Loop - Policy intervention (metabolic only)
                    if (this.institutionType === 'metabolic' && avgEudaimonia < 60) {
                        if (agent.eudaimonia < 50 && Math.random() < 0.05) {
                            agent.stress = Math.max(0, agent.stress - 0.20);
                            agent.moralDebt = Math.max(0, agent.moralDebt - 10);
                            this.repairEvents.institutional++;
                        }
                    }
                    
                    // Extractive institution punishment
                    if (this.institutionType === 'extractive') {
                        if (agent.eudaimonia < 40) {
                            agent.stress = Math.min(1.0, agent.stress + 0.3);
                            agent.moralDebt = Math.min(100, agent.moralDebt + 10);
                            agent.prfCoherence = Math.max(0, agent.prfCoherence - 0.05);
                        }
                    }
                    
                    // Natural recovery (metabolic only)
                    if (this.institutionType === 'metabolic') {
                        agent.stress = Math.max(0, agent.stress - 0.05);
                        if (agent.stress < 0.3) {
                            Object.keys(agent.virtues).forEach(v => {
                                agent.virtues[v] = Math.min(100, agent.virtues[v] + 0.08);
                            });
                        }
                    }
                });
            }
            
            getFinalMetrics() {
                const avgEudaimonia = this.agents.reduce((sum, a) => sum + a.eudaimonia, 0) / this.numAgents;
                const avgStress = this.agents.reduce((sum, a) => sum + a.stress, 0) / this.numAgents;
                const avgCoherence = this.agents.reduce((sum, a) => sum + a.prfCoherence, 0) / this.numAgents;
                const avgMoralDebt = this.agents.reduce((sum, a) => sum + a.moralDebt, 0) / this.numAgents;
                
                return {
                    eudaimonia: avgEudaimonia,
                    stress: avgStress,
                    coherence: avgCoherence,
                    moralDebt: avgMoralDebt,
                    repairs: this.repairEvents
                };
            }
            
            getTimeSeriesData() {
                const numTimesteps = this.agents[0].history.length;
                const data = {
                    eudaimonia: [],
                    virtues: { courage: [], temperance: [], wisdom: [], justice: [] },
                    stress: [],
                    coherence: []
                };
                
                for (let t = 0; t < numTimesteps; t++) {
                    const avgEud = this.agents.reduce((sum, a) => sum + a.history[t].eudaimonia, 0) / this.numAgents;
                    data.eudaimonia.push(avgEud);
                    
                    Object.keys(data.virtues).forEach(v => {
                        const avgVirtue = this.agents.reduce((sum, a) => sum + a.history[t].virtues[v], 0) / this.numAgents;
                        data.virtues[v].push(avgVirtue);
                    });
                    
                    const avgStress = this.agents.reduce((sum, a) => sum + a.history[t].stress, 0) / this.numAgents;
                    data.stress.push(avgStress);
                    
                    const avgCoherence = this.agents.reduce((sum, a) => sum + a.history[t].prfCoherence, 0) / this.numAgents;
                    data.coherence.push(avgCoherence);
                }
                
                return data;
            }
        }
        
        // ========================================================================
        // UI LOGIC
        // ========================================================================
        
        let currentResults = null;
        let charts = {};
        
        // Update scenario info when selection changes
        document.getElementById('scenarioSelect').addEventListener('change', function() {
            updateScenarioInfo();
        });
        
        function updateScenarioInfo() {
            const scenario = SCENARIOS[document.getElementById('scenarioSelect').value];
            document.getElementById('scenarioDescription').textContent = scenario.description;
            document.getElementById('scenarioVirtue').textContent = scenario.virtue;
            document.getElementById('scenarioConnection').textContent = scenario.connection;
        }
        
        // Update slider values
        document.getElementById('numAgents').addEventListener('input', function() {
            document.getElementById('numAgentsValue').textContent = this.value;
        });
        
        document.getElementById('numTimesteps').addEventListener('input', function() {
            document.getElementById('numTimestepsValue').textContent = this.value;
        });
        
        // Radio button styling
        document.querySelectorAll('.radio-option').forEach(option => {
            option.addEventListener('click', function() {
                const input = this.querySelector('input[type="radio"]');
                input.checked = true;
                
                // Update styling
                const group = this.parentElement;
                group.querySelectorAll('.radio-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                
                // Show/hide institution type selection
                if (input.name === 'mode') {
                    const institutionGroup = document.getElementById('institutionTypeGroup');
                    if (input.value === 'comparison') {
                        institutionGroup.style.display = 'none';
                    } else {
                        institutionGroup.style.display = 'block';
                    }
                }
            });
        });
        
        // Run simulation
        document.getElementById('runButton').addEventListener('click', runSimulation);
        
        async function runSimulation() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const scenarioKey = document.getElementById('scenarioSelect').value;
            const scenario = SCENARIOS[scenarioKey];
            const numAgents = parseInt(document.getElementById('numAgents').value);
            const numTimesteps = parseInt(document.getElementById('numTimesteps').value);
            
            // Hide welcome and results
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('resultsSection').classList.remove('active');
            
            // Show progress
            document.getElementById('progressBar').classList.add('active');
            document.getElementById('runButton').disabled = true;
            
            if (mode === 'individual') {
                const institution = document.querySelector('input[name="institution"]:checked').value;
                await runSingleSimulation(scenario, numAgents, numTimesteps, institution);
            } else {
                await runComparison(scenario, numAgents, numTimesteps);
            }
            
            // Hide progress
            document.getElementById('progressBar').classList.remove('active');
            document.getElementById('runButton').disabled = false;
            document.getElementById('downloadButton').disabled = false;
            
            // Show results
            document.getElementById('resultsSection').classList.add('active');
        }
        
        async function runSingleSimulation(scenario, numAgents, numTimesteps, institution) {
            showStatus(`Running ${institution} institution simulation...`, 'info');
            
            const community = new Community(numAgents, institution);
            community.applyShock(scenario);
            
            await simulateWithProgress(community, numTimesteps);
            
            showStatus('‚úÖ Simulation complete!', 'success');
            
            currentResults = {
                mode: 'single',
                institution: institution,
                scenario: scenario,
                community: community
            };
            
            displayResults();
        }
        
        async function runComparison(scenario, numAgents, numTimesteps) {
            const results = {};
            
            // Run metabolic
            showStatus('Running METABOLIC institution simulation...', 'info');
            const metabolic = new Community(numAgents, 'metabolic');
            metabolic.applyShock(scenario);
            await simulateWithProgress(metabolic, numTimesteps);
            results.metabolic = metabolic;
            
            // Short delay
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Run extractive
            showStatus('Running EXTRACTIVE institution simulation...', 'info');
            const extractive = new Community(numAgents, 'extractive');
            extractive.applyShock(scenario);
            await simulateWithProgress(extractive, numTimesteps);
            results.extractive = extractive;
            
            showStatus('‚úÖ Comparison complete!', 'success');
            
            currentResults = {
                mode: 'comparison',
                scenario: scenario,
                results: results
            };
            
            displayComparison();
        }
        
        function simulateWithProgress(community, numTimesteps) {
            return new Promise(resolve => {
                // Use setTimeout to allow UI updates
                setTimeout(() => {
                    community.simulate(numTimesteps, (progress) => {
                        updateProgress(progress);
                    });
                    resolve();
                }, 100);
            });
        }
        
        function updateProgress(percent) {
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = Math.round(percent) + '%';
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = 'status-message active ' + type;
        }
        
        function displayResults() {
            const { community, institution } = currentResults;
            const metrics = community.getFinalMetrics();
            const timeData = community.getTimeSeriesData();
            
            // Clear previous results
            document.getElementById('metricsGrid').innerHTML = '';
            document.getElementById('comparisonGrid').style.display = 'none';
            document.getElementById('insightBox').style.display = 'none';
            
            // Display metrics
            displayMetrics(metrics, 50); // Compare to starting value of 50
            
            // Create charts
            createEudaimoniaChart(timeData.eudaimonia);
            createVirtueChart(timeData.virtues, timeData.eudaimonia.length);
            createStressChart(timeData.stress, timeData.coherence);
        }
        
        function displayComparison() {
            const { results } = currentResults;
            const metabolicMetrics = results.metabolic.getFinalMetrics();
            const extractiveMetrics = results.extractive.getFinalMetrics();
            const metabolicData = results.metabolic.getTimeSeriesData();
            const extractiveData = results.extractive.getTimeSeriesData();
            
            // Clear previous
            document.getElementById('metricsGrid').innerHTML = '';
            document.getElementById('comparisonGrid').innerHTML = '';
            
            // Show insight box
            const eudDiff = metabolicMetrics.eudaimonia - extractiveMetrics.eudaimonia;
            const insightBox = document.getElementById('insightBox');
            insightBox.style.display = 'block';
            insightBox.innerHTML = `
                <h3>üí° Key Insight</h3>
                <p style="font-size: 1.2em; margin-bottom: 15px;">
                    <strong>The SAME ethical crisis produced a ${Math.abs(eudDiff).toFixed(1)} point difference in eudaimonia!</strong>
                </p>
                <p style="line-height: 1.7;">
                    Metabolic institution enabled <strong>${metabolicMetrics.repairs.biobond + metabolicMetrics.repairs.civic + metabolicMetrics.repairs.institutional} repair events</strong>.<br>
                    Extractive institution enabled <strong>${extractiveMetrics.repairs.biobond + extractiveMetrics.repairs.civic + extractiveMetrics.repairs.institutional} repair events</strong>.
                </p>
                <p style="margin-top: 15px; font-style: italic;">
                    "The polis exists to make eudaimonia POSSIBLE." - Aristotle
                </p>
            `;
            
            // Comparison cards
            const comparisonGrid = document.getElementById('comparisonGrid');
            comparisonGrid.style.display = 'grid';
            
            comparisonGrid.innerHTML = `
                <div class="comparison-card metabolic">
                    <h3>üå± Metabolic Institution</h3>
                    ${createMetricsList(metabolicMetrics)}
                </div>
                <div class="comparison-card extractive">
                    <h3>‚ö° Extractive Institution</h3>
                    ${createMetricsList(extractiveMetrics)}
                </div>
            `;
            
            // Create comparison charts
            createComparisonChart(metabolicData.eudaimonia, extractiveData.eudaimonia);
            createVirtueChart({
                'Metabolic Eudaimonia': metabolicData.eudaimonia,
                'Extractive Eudaimonia': extractiveData.eudaimonia
            }, metabolicData.eudaimonia.length);
            createStressComparisonChart(metabolicData.stress, extractiveData.stress);
        }
        
        function createMetricsList(metrics) {
            return `
                <div style="margin: 20px 0;">
                    <p style="font-size: 1.1em; margin: 10px 0;">
                        <strong>Eudaimonia:</strong> ${metrics.eudaimonia.toFixed(1)}/100
                    </p>
                    <p style="font-size: 1.1em; margin: 10px 0;">
                        <strong>Stress:</strong> ${metrics.stress.toFixed(2)}
                    </p>
                    <p style="font-size: 1.1em; margin: 10px 0;">
                        <strong>Soul Integrity:</strong> ${metrics.coherence.toFixed(2)}
                    </p>
                    <p style="font-size: 1.1em; margin: 10px 0;">
                        <strong>Moral Debt:</strong> ${metrics.moralDebt.toFixed(1)}
                    </p>
                    <hr style="margin: 15px 0; border: 1px solid #ddd;">
                    <p style="font-size: 1.1em; margin: 10px 0;">
                        <strong>Repair Events:</strong>
                    </p>
                    <p style="margin: 5px 0; padding-left: 20px;">
                        üßò BioBond: ${metrics.repairs.biobond}
                    </p>
                    <p style="margin: 5px 0; padding-left: 20px;">
                        ü§ù Civic: ${metrics.repairs.civic}
                    </p>
                    <p style="margin: 5px 0; padding-left: 20px;">
                        üèõÔ∏è Institutional: ${metrics.repairs.institutional}
                    </p>
                </div>
            `;
        }
        
        function displayMetrics(metrics, baseline) {
            const grid = document.getElementById('metricsGrid');
            
            const metricCards = [
                {
                    label: 'Eudaimonia',
                    value: metrics.eudaimonia.toFixed(1),
                    change: (metrics.eudaimonia - baseline).toFixed(1),
                    suffix: '/100'
                },
                {
                    label: 'Stress Level',
                    value: metrics.stress.toFixed(2),
                    change: (metrics.stress - 0).toFixed(2),
                    suffix: ''
                },
                {
                    label: 'Soul Integrity',
                    value: metrics.coherence.toFixed(2),
                    change: (metrics.coherence - 1.0).toFixed(2),
                    suffix: ''
                },
                {
                    label: 'Repair Events',
                    value: (metrics.repairs.biobond + metrics.repairs.civic + metrics.repairs.institutional),
                    change: '',
                    suffix: ''
                }
            ];
            
            metricCards.forEach(card => {
                const changeClass = card.change > 0 ? 'positive' : (card.change < 0 ? 'negative' : '');
                const changeSymbol = card.change > 0 ? '+' : '';
                
                grid.innerHTML += `
                    <div class="metric-card">
                        <div class="metric-label">${card.label}</div>
                        <div class="metric-value">${card.value}${card.suffix}</div>
                        ${card.change !== '' ? `<div class="metric-change ${changeClass}">${changeSymbol}${card.change} from start</div>` : ''}
                    </div>
                `;
            });
        }
        
        // Chart creation functions
        function createEudaimoniaChart(data) {
            const ctx = document.getElementById('eudaimoniaChart');
            
            if (charts.eudaimonia) {
                charts.eudaimonia.destroy();
            }
            
            charts.eudaimonia = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: data.length}, (_, i) => i),
                    datasets: [{
                        label: 'Community Average Eudaimonia',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Eudaimonia (Flourishing)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time Step'
                            }
                        }
                    }
                }
            });
        }
        
        function createComparisonChart(metabolicData, extractiveData) {
            const ctx = document.getElementById('eudaimoniaChart');
            
            if (charts.eudaimonia) {
                charts.eudaimonia.destroy();
            }
            
            charts.eudaimonia = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: metabolicData.length}, (_, i) => i),
                    datasets: [
                        {
                            label: 'üå± Metabolic Institution',
                            data: metabolicData,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: '‚ö° Extractive Institution',
                            data: extractiveData,
                            borderColor: '#f44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Eudaimonia (Flourishing)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time Step'
                            }
                        }
                    }
                }
            });
        }
        
        function createVirtueChart(virtues, length) {
            const ctx = document.getElementById('virtueChart');
            
            if (charts.virtue) {
                charts.virtue.destroy();
            }
            
            const labels = Array.from({length: length}, (_, i) => i);
            const datasets = [];
            
            if (virtues.courage) {
                // Individual mode - show all virtues
                const colors = {
                    courage: '#f44336',
                    temperance: '#2196F3',
                    wisdom: '#FF9800',
                    justice: '#4CAF50'
                };
                
                Object.keys(virtues).forEach(virtue => {
                    datasets.push({
                        label: virtue.charAt(0).toUpperCase() + virtue.slice(1),
                        data: virtues[virtue],
                        borderColor: colors[virtue],
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false
                    });
                });
            } else {
                // Comparison mode - show eudaimonia comparison
                Object.keys(virtues).forEach(key => {
                    const color = key.includes('Metabolic') ? '#4CAF50' : '#f44336';
                    datasets.push({
                        label: key,
                        data: virtues[key],
                        borderColor: color,
                        borderWidth: 3,
                        tension: 0.4,
                        fill: false
                    });
                });
            }
            
            charts.virtue = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Level'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time Step'
                            }
                        }
                    }
                }
            });
        }
        
        function createStressChart(stress, coherence) {
            const ctx = document.getElementById('stressChart');
            
            if (charts.stress) {
                charts.stress.destroy();
            }
            
            charts.stress = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: stress.length}, (_, i) => i),
                    datasets: [
                        {
                            label: 'Stress',
                            data: stress,
                            borderColor: '#f44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y',
                            fill: true
                        },
                        {
                            label: 'Soul Integrity (PRF Coherence)',
                            data: coherence,
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1.0,
                            title: {
                                display: true,
                                text: 'Level (0-1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time Step'
                            }
                        }
                    }
                }
            });
        }
        
        function createStressComparisonChart(metabolicStress, extractiveStress) {
            const ctx = document.getElementById('stressChart');
            
            if (charts.stress) {
                charts.stress.destroy();
            }
            
            charts.stress = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: metabolicStress.length}, (_, i) => i),
                    datasets: [
                        {
                            label: 'üå± Metabolic Stress',
                            data: metabolicStress,
                            borderColor: '#4CAF50',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: false
                        },
                        {
                            label: '‚ö° Extractive Stress',
                            data: extractiveStress,
                            borderColor: '#f44336',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1.0,
                            title: {
                                display: true,
                                text: 'Stress Level'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time Step'
                            }
                        }
                    }
                }
            });
        }
        
        // Download data
        document.getElementById('downloadButton').addEventListener('click', function() {
            if (!currentResults) return;
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            if (currentResults.mode === 'single') {
                const { community } = currentResults;
                csvContent += "timestep,agent_id,eudaimonia,stress,coherence,courage,temperance,wisdom,justice\n";
                
                community.agents.forEach(agent => {
                    agent.history.forEach((record, t) => {
                        csvContent += `${t},${agent.id},${record.eudaimonia.toFixed(2)},${record.stress.toFixed(2)},${record.prfCoherence.toFixed(2)},`;
                        csvContent += `${record.virtues.courage.toFixed(2)},${record.virtues.temperance.toFixed(2)},${record.virtues.wisdom.toFixed(2)},${record.virtues.justice.toFixed(2)}\n`;
                    });
                });
            } else {
                csvContent += "timestep,institution,agent_id,eudaimonia,stress,coherence\n";
                
                ['metabolic', 'extractive'].forEach(inst => {
                    const community = currentResults.results[inst];
                    community.agents.forEach(agent => {
                        agent.history.forEach((record, t) => {
                            csvContent += `${t},${inst},${agent.id},${record.eudaimonia.toFixed(2)},${record.stress.toFixed(2)},${record.prfCoherence.toFixed(2)}\n`;
                        });
                    });
                });
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "simulation_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Initialize
        updateScenarioInfo();
    </script>
</body>
</html>
